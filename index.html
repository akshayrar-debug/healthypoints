<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthy Menu Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .thumbnail-container {
            position: relative;
        }
        .remove-btn {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            background-color: rgba(0,0,0,0.7);
            color: white;
            border-radius: 50%;
            width: 1.75rem;
            height: 1.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8 relative">
        
        <!-- Splash Screen -->
        <div id="splash-screen">
            <div class="text-center">
                <svg class="mx-auto h-16 w-16 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75l-2.489-2.489m0 0a3.375 3.375 0 10-4.773-4.773 3.375 3.375 0 004.774 4.774zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l1.5 1.5 3-3.75M12 18.75a6.75 6.75 0 006.75-6.75H5.25A6.75 6.75 0 0012 18.75z" />
                </svg>
                <h1 class="mt-4 text-2xl font-bold text-gray-900">Healthy Menu Scanner</h1>
                <p class="mt-2 text-gray-600">Snap photos of your menu and get instant, healthy meal recommendations.</p>
            </div>
            <div class="mt-8 space-y-4">
                <input type="file" id="menu-image-input" accept="image/*" class="hidden" multiple>
                <button id="take-photo-button" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>Click a Photo</span>
                </button>
                <button id="select-photos-button" class="w-full bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    <span>Select from Gallery</span>
                </button>
            </div>
        </div>

        <!-- Image Preview Screen -->
        <div id="preview-screen" class="hidden">
            <button id="home-button-preview" class="absolute top-4 left-4 p-2 rounded-full hover:bg-gray-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-gray-900 text-center pt-8">Your Selected Photos</h2>
            <div id="image-preview-gallery" class="mt-4 grid grid-cols-3 gap-4 max-h-64 overflow-y-auto p-2 bg-gray-50 rounded-lg">
                <!-- Image thumbnails will be injected here -->
            </div>
            <div class="mt-6">
                <button id="confirm-photos-button" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700">Next</button>
            </div>
        </div>
        
        <!-- Preferences Screen -->
        <div id="preferences-screen" class="hidden">
            <button id="home-button-prefs" class="absolute top-4 left-4 p-2 rounded-full hover:bg-gray-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-gray-900 text-center pt-8">Tell Us Your Preferences</h2>
            <div class="mt-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Dietary Preferences</label>
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center">
                            <input id="pref-any" name="preference" type="radio" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500" value="Anything works" checked>
                            <label for="pref-any" class="ml-3 block text-sm font-medium text-gray-700">Anything works</label>
                        </div>
                        <div class="flex items-center">
                            <input id="pref-chicken" name="preference" type="radio" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500" value="Chicken">
                            <label for="pref-chicken" class="ml-3 block text-sm font-medium text-gray-700">Chicken</label>
                        </div>
                        <div class="flex items-center">
                            <input id="pref-veg" name="preference" type="radio" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500" value="Vegetarian">
                            <label for="pref-veg" class="ml-3 block text-sm font-medium text-gray-700">Veg</label>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Items to avoid</label>
                    <div class="mt-2 grid grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <input id="avoid-dairy" name="avoid" type="checkbox" value="Dairy" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="avoid-dairy" class="ml-3 block text-sm font-medium text-gray-700">Dairy</label>
                        </div>
                        <div class="flex items-center">
                            <input id="avoid-peanuts" name="avoid" type="checkbox" value="Peanuts" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="avoid-peanuts" class="ml-3 block text-sm font-medium text-gray-700">Peanuts</label>
                        </div>
                        <div class="flex items-center">
                            <input id="avoid-onion" name="avoid" type="checkbox" value="Onion" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="avoid-onion" class="ml-3 block text-sm font-medium text-gray-700">Onion</label>
                        </div>
                    </div>
                </div>
            </div>
             <div class="mt-8">
                <button id="analyze-button" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700">Get Recommendations</button>
            </div>
        </div>


        <!-- Loading Screen -->
        <div id="loading-screen" class="hidden">
            <div class="flex flex-col items-center justify-center text-center">
                <div class="loader"></div>
                <p id="loading-message" class="mt-4 text-gray-700 font-medium">Analyzing menu...</p>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="hidden fade-in">
             <button id="home-button-results" class="absolute top-4 left-4 p-2 rounded-full hover:bg-gray-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-gray-900 text-center pt-8">Your Recommendation</h2>
            <div id="recommendation-output" class="mt-6 space-y-6">
                <!-- Recommendations will be injected here -->
            </div>
            <div class="mt-6 text-center text-xs text-gray-500">
                <p>Disclaimer: Nutritional and ingredient information is an estimate and may vary based on preparation. Please verify with the restaurant for any dietary concerns.</p>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
            <strong class="font-bold">Oops!</strong>
            <span class="block sm:inline" id="error-text">Something went wrong.</span>
        </div>

    </div>

    <script>
        // --- DOM Elements ---
        const splashScreen = document.getElementById('splash-screen');
        const previewScreen = document.getElementById('preview-screen');
        const preferencesScreen = document.getElementById('preferences-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const resultsScreen = document.getElementById('results-screen');
        
        const takePhotoButton = document.getElementById('take-photo-button');
        const selectPhotosButton = document.getElementById('select-photos-button');
        const imageInput = document.getElementById('menu-image-input');
        const imagePreviewGallery = document.getElementById('image-preview-gallery');
        const confirmPhotosButton = document.getElementById('confirm-photos-button');
        const homeButtonPreview = document.getElementById('home-button-preview');
        const homeButtonPrefs = document.getElementById('home-button-prefs');
        const homeButtonResults = document.getElementById('home-button-results');
        const analyzeButton = document.getElementById('analyze-button');
        
        const recommendationOutput = document.getElementById('recommendation-output');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const loadingMessage = document.getElementById('loading-message');

        // --- State ---
        let selectedImagesData = [];
        let fullRecommendationData = null;
        let isShowingTopRecs = true;
        
        // --- Event Listeners ---
        takePhotoButton.addEventListener('click', () => {
            imageInput.removeAttribute('multiple');
            imageInput.setAttribute('capture', 'environment');
            imageInput.click();
        });
        selectPhotosButton.addEventListener('click', () => {
            imageInput.setAttribute('multiple', '');
            imageInput.removeAttribute('capture');
            imageInput.click();
        });
        homeButtonPreview.addEventListener('click', resetApp);
        homeButtonPrefs.addEventListener('click', resetApp);
        homeButtonResults.addEventListener('click', resetApp);
        imageInput.addEventListener('change', handleImageSelection);
        confirmPhotosButton.addEventListener('click', () => showScreen('preferences'));
        analyzeButton.addEventListener('click', handleAnalysis);

        // --- Core Functions ---

        async function handleImageSelection(event) {
            const files = event.target.files;
            if (!files.length) return;
            showLoading('Processing images...');
            try {
                for (const file of files) {
                    const base64 = await fileToBase64(file);
                    const url = URL.createObjectURL(file);
                    selectedImagesData.push({ url, base64 });
                }
                renderImagePreviews();
                showScreen('preview');
            } catch (error) {
                console.error("Error reading files:", error);
                showError("Could not read the selected files.");
                resetApp();
            }
        }

        function renderImagePreviews() {
            imagePreviewGallery.innerHTML = '';
            selectedImagesData.forEach((imageData, index) => {
                const thumbContainer = document.createElement('div');
                thumbContainer.className = 'thumbnail-container';
                const img = document.createElement('img');
                img.src = imageData.url;
                img.className = 'w-full h-24 object-cover rounded-md';
                const removeBtn = document.createElement('div');
                removeBtn.className = 'remove-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.dataset.index = index;
                removeBtn.onclick = removeImage;
                thumbContainer.appendChild(img);
                thumbContainer.appendChild(removeBtn);
                imagePreviewGallery.appendChild(thumbContainer);
            });
            const addMoreContainer = document.createElement('div');
            const addMoreBtn = document.createElement('button');
            addMoreBtn.id = 'add-more-button';
            addMoreBtn.className = 'w-full h-24 border-2 border-dashed rounded-md flex items-center justify-center text-gray-400 hover:bg-gray-100 transition-colors';
            addMoreBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>`;
            addMoreBtn.onclick = () => {
                imageInput.setAttribute('multiple', '');
                imageInput.removeAttribute('capture');
                imageInput.click();
            };
            addMoreContainer.appendChild(addMoreBtn);
            imagePreviewGallery.appendChild(addMoreContainer);
        }
        
        function removeImage(event) {
            const indexToRemove = parseInt(event.target.dataset.index, 10);
            URL.revokeObjectURL(selectedImagesData[indexToRemove].url);
            selectedImagesData.splice(indexToRemove, 1);
            renderImagePreviews();
        }

        async function handleAnalysis() {
            if (selectedImagesData.length === 0) {
                showError("Please select at least one menu photo.");
                return;
            }
            showLoading('Reading menu...');
            hideError();
            const dietPreference = document.querySelector('input[name="preference"]:checked').value;
            const itemsToAvoidCheckboxes = document.querySelectorAll('input[name="avoid"]:checked');
            let itemsToAvoid = [];
            itemsToAvoidCheckboxes.forEach(checkbox => {
                itemsToAvoid.push(checkbox.value);
            });
            const itemsToAvoidString = itemsToAvoid.join(', ');
            const userPreferences = {
                diet: dietPreference,
                allergies: itemsToAvoidString
            };
            try {
                const base64Images = selectedImagesData.map(d => d.base64);
                const menuItems = await extractMenuItems(base64Images);
                if (!menuItems || menuItems.length === 0) {
                    throw new Error("The AI couldn't find any menu items. Please try clearer photos.");
                }
                showLoading('Finding personalized recommendations...');
                const recommendation = await getHealthyRecommendation(menuItems, userPreferences);
                displayResults(recommendation);
                showScreen('results');
            } catch (error) {
                console.error("Error during processing:", error);
                showError(error.message || "An unknown error occurred.");
                resetApp(); 
            }
        }

        async function extractMenuItems(imagesBase64Array) {
            const parts = [
                { text: "Analyze the images of a restaurant menu. Detect the currency symbol (e.g., $, €, ₹). If no currency is found, default to 'INR'. Extract all menu items, descriptions, and prices. If an item has no price, the price should be null. Return a single JSON array where each object has 'itemName', 'itemDescription', 'itemPrice' (as a number or null), and 'currencySymbol'." }
            ];
            imagesBase64Array.forEach(base64String => {
                parts.push({ inlineData: { mimeType: "image/jpeg", data: base64String } });
            });
            const payload = {
                contents: [{ parts }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "itemName": { "type": "STRING" },
                                "itemDescription": { "type": "STRING" },
                                "itemPrice": { "type": "NUMBER", "nullable": true },
                                "currencySymbol": { "type": "STRING" }
                            },
                            required: ["itemName", "itemDescription", "itemPrice", "currencySymbol"]
                        }
                    }
                }
            };
            const response = await makeApiCall('vision', payload);
            if (!response.candidates?.[0]?.content?.parts?.[0]?.text) {
                console.error("Invalid API response structure from Vision model:", response);
                throw new Error("The AI model returned an unexpected response. Please try again.");
            }
            const jsonText = response.candidates[0].content.parts[0].text;
            try {
                return JSON.parse(jsonText);
            } catch (e) {
                console.error("Failed to parse JSON from Vision model:", jsonText);
                throw new Error("The AI model returned malformed data. Please try again.");
            }
        }

        async function getHealthyRecommendation(menuItems, preferences) {
            const prompt = `
                You are a helpful nutrition expert. Given menu items and user preferences, provide a healthy meal recommendation.

                **User Preferences:**
                - Dietary Preference: ${preferences.diet}
                - Items to Avoid: ${preferences.allergies || 'None specified'}

                **Menu Items:** ${JSON.stringify(menuItems)}

                **Your Task:**
                1.  Find up to 3 healthiest dishes that match the user's preferences. These are the "topRecommendations".
                2.  For EACH top recommendation, provide a detailed, single-paragraph explanation about the dish, its ingredients, and health benefits. Also provide its individual nutritional breakdown (calories, protein, carbs, fat). Ensure units are correct (e.g., "120kcal", "20g").
                3.  If more than 3 matching healthy dishes exist, find an additional list of up to 3 "moreRecommendations". For these, also provide a full explanation and nutritional breakdown just like the top ones.
                4.  Calculate the total price for ONLY the top recommendations. Only include items that have a price.
                5.  Determine the currency symbol from the first item that has one.
                6.  Provide a single, combined nutritional summary for ONLY the top recommendations. Include an estimated portion size in grams.

                Return a single JSON object with the specified structure.
            `;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "topRecommendations": {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        "name": { "type": "STRING" },
                                        "price": { "type": "NUMBER", "nullable": true },
                                        "explanation": { "type": "STRING" },
                                        "nutrition": {
                                            type: "OBJECT",
                                            properties: {
                                                "calories": { "type": "STRING" },
                                                "protein": { "type": "STRING" },
                                                "carbs": { "type": "STRING" },
                                                "fat": { "type": "STRING" }
                                            }
                                        }
                                    }
                                }
                            },
                            "moreRecommendations": {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        "name": { "type": "STRING" },
                                        "price": { "type": "NUMBER", "nullable": true },
                                        "explanation": { "type": "STRING" },
                                        "nutrition": {
                                            type: "OBJECT",
                                            properties: {
                                                "calories": { "type": "STRING" },
                                                "protein": { "type": "STRING" },
                                                "carbs": { "type": "STRING" },
                                                "fat": { "type": "STRING" }
                                            }
                                        }
                                    }
                                }
                            },
                            "totalPrice": { "type": "NUMBER" },
                            "currencySymbol": { "type": "STRING" },
                            "combinedNutrition": {
                                type: "OBJECT",
                                properties: {
                                    "calories": { "type": "STRING" },
                                    "protein": { "type": "STRING" },
                                    "carbs": { "type": "STRING" },
                                    "fat": { "type": "STRING" },
                                    "portionSize": { "type": "STRING" }
                                }
                            }
                        },
                        required: ["topRecommendations", "moreRecommendations", "totalPrice", "currencySymbol", "combinedNutrition"]
                    }
                }
            };
            const response = await makeApiCall('vision', payload);
            if (!response.candidates?.[0]?.content?.parts?.[0]?.text) {
                console.error("Invalid API response structure from Recommendation model:", response);
                throw new Error("The AI model returned an unexpected response while analyzing nutrition.");
            }
            const jsonText = response.candidates[0].content.parts[0].text;
            try {
                return JSON.parse(jsonText);
            } catch (e) {
                console.error("Failed to parse JSON from Recommendation model:", jsonText);
                throw new Error("The AI model returned malformed data while analyzing nutrition.");
            }
        }
        
        function displayResults(recommendation) {
            fullRecommendationData = recommendation;
            isShowingTopRecs = true;
            renderDisplay();
        }

        function renderDisplay() {
            const recsToShow = isShowingTopRecs ? fullRecommendationData.topRecommendations : fullRecommendationData.moreRecommendations;
            const additionalRecs = isShowingTopRecs ? fullRecommendationData.moreRecommendations : fullRecommendationData.topRecommendations;
            const nutritionToShow = isShowingTopRecs ? fullRecommendationData.combinedNutrition : null; // Only show total for top recs

            let html = `
                <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg">
                    <h3 class="text-lg font-semibold text-gray-800">Your Recommendation</h3>
                    <div id="top-recs-list" class="mt-2 space-y-1">
            `;

            if (recsToShow.length === 0) {
                 html += `<p class="text-gray-600">Sorry, no suitable options could be found based on your preferences.</p>`;
            }

            recsToShow.forEach((item, index) => {
                let priceHtml = '';
                if (item.price !== null) {
                    priceHtml = `<span class="font-medium text-gray-900">${fullRecommendationData.currencySymbol}${item.price.toFixed(2)}</span>`;
                }
                html += `
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">${index + 1}. ${item.name}</span>
                        ${priceHtml}
                    </div>
                `;
            });

            const totalPrice = recsToShow.reduce((acc, item) => acc + (item.price || 0), 0);
            if (totalPrice > 0) {
                html += `
                        </div>
                        <hr class="my-3 border-green-200">
                        <div class="flex justify-between items-center font-bold text-lg">
                            <span>Total</span>
                            <span>${fullRecommendationData.currencySymbol}${totalPrice.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            } else {
                 html += `</div></div>`;
            }
            
            if (recsToShow.length > 0 && recsToShow.length < 3) {
                html += `<p class="text-xs text-center text-gray-500 mt-2">These are the only available options based on your preferences.</p>`;
            }

            if (recsToShow.length > 0) {
                html += `
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg mt-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800">Why It's a Good Choice</h3>
                            ${nutritionToShow ? `<span class="text-sm font-medium text-gray-700">Total Calories: ${nutritionToShow.calories}</span>` : ''}
                        </div>
                        <div class="mt-2 text-gray-700 space-y-4">
                `;
                recsToShow.forEach(item => {
                    html += `
                        <div>
                            <h4 class="font-semibold">${item.name}</h4>
                            <p class="text-sm">${item.explanation}</p>
                            <div class="text-xs bg-gray-100 rounded-full px-3 py-1 mt-2 inline-block">
                                <span class="font-semibold">Cal:</span> ${item.nutrition.calories} &nbsp;&nbsp;
                                <span class="font-semibold">P:</span> ${item.nutrition.protein} &nbsp;&nbsp;
                                <span class="font-semibold">C:</span> ${item.nutrition.carbs} &nbsp;&nbsp;
                                <span class="font-semibold">F:</span> ${item.nutrition.fat}
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }

            if (additionalRecs.length > 0) {
                html += `
                    <div id="more-recs-container" class="mt-4 bg-gray-50 p-4 rounded-lg">
                         <h3 class="text-md font-semibold text-gray-700">Additional Options</h3>
                         <div id="more-recs-list" class="mt-2 space-y-1 text-gray-600">
                `;
                additionalRecs.forEach(item => {
                    html += `<p>${item.name}</p>`;
                });
                html += `</div><button id="show-details-btn" class="text-sm text-blue-600 hover:underline mt-2">Show details</button></div>`;
            }

            if (nutritionToShow) {
                html += `
                    <div class="bg-gray-50 p-4 rounded-lg mt-6">
                        <h3 class="text-lg font-semibold text-gray-800">Estimated Nutrition (per portion)</h3>
                        <div class="mt-2 grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                            <div class="flex justify-between"><span class="text-gray-600">Calories:</span> <span class="font-medium text-gray-800">${nutritionToShow.calories}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Protein:</span> <span class="font-medium text-gray-800">${nutritionToShow.protein}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Carbs:</span> <span class="font-medium text-gray-800">${nutritionToShow.carbs}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Fat:</span> <span class="font-medium text-gray-800">${nutritionToShow.fat}</span></div>
                            <div class="flex justify-between col-span-2"><span class="text-gray-600">Portion Size:</span> <span class="font-medium text-gray-800">${nutritionToShow.portionSize}</span></div>
                        </div>
                    </div>
                `;
            }
            recommendationOutput.innerHTML = html;

            const showDetailsBtn = document.getElementById('show-details-btn');
            if (showDetailsBtn) {
                showDetailsBtn.addEventListener('click', () => {
                    isShowingTopRecs = !isShowingTopRecs;
                    renderDisplay();
                });
            }
        }

        function resetApp() {
            showScreen('splash');
            imageInput.value = ''; 
            selectedImagesData.forEach(d => URL.revokeObjectURL(d.url));
            selectedImagesData = [];
            fullRecommendationData = null;
            imagePreviewGallery.innerHTML = '';
            recommendationOutput.innerHTML = '';
            hideError();
        }

        // --- UI State Changers ---
        function showScreen(screenName) {
            ['splash', 'preview', 'preferences', 'loading', 'results'].forEach(id => {
                document.getElementById(`${id}-screen`).classList.add('hidden');
            });
            document.getElementById(`${screenName}-screen`).classList.remove('hidden');
        }

        function showLoading(message) {
            loadingMessage.textContent = message;
            showScreen('loading');
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        // --- Utility Functions ---

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
        
        async function makeApiCall(targetApi, payload) {
            try {
                const functionUrl = new URL('/gemini', window.location.href);
                const response = await fetch(functionUrl.href, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetApi, payload })
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(errorBody.error || `API Error: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error making API call:', error);
                throw error;
            }
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, numChannels, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2 * numChannels, true);
            view.setUint16(32, numChannels * 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.length * 2, true);
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

    </script>
</body>
</html>
